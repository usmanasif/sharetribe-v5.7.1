- content_for :javascript do
  initialize_send_message_form('#{I18n.locale}');
  ST.transaction.initializePayPalBuyForm("transaction-form", #{paypal_analytics_event.to_json.html_safe});

- content_for :extra_javascript do
  :javascript
    $('#transaction-agreement-read-more').click(function() { $('#transaction-agreement-content').lightbox_me({centered: true, zIndex: 1000000}); });
= javascript_include_tag "https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"

- content_for :title_header do
  %h1
    = action_button_label
    = link_to(listing[:title], listing_path(listing[:id]))

#new_message_form.centered-section

  - author_link = link_to(author[:display_name], person_path(username: author[:username]))

  .preauthorize-section
    %h2.preauthorize-details-title
      = t("listing_conversations.preauthorize.details")

    %ul.no-bullets
      %li
        %div
          = t("listing_conversations.preauthorize.by", listing: link_to("#{listing[:title]}", listing_path(listing[:id])), author: author_link).html_safe

      %li
        = render partial: "transactions/price_break_down", locals: price_break_down_locals

  = form_tag form_action, method: :post,:target => "_blank" ,id: "transaction-form" do

    = hidden_field_tag(:start_on, start_on&.iso8601 )
    = hidden_field_tag(:end_on, end_on&.iso8601 )

    .preauthorize-section
      %h2
        = t("conversations.new.optional_message_to", author_name: author_link).html_safe

      .row
        .col-12
          = text_area_tag :message, nil, :class => "text_area"

      - if @current_community.transaction_agreement_in_use
        = render :partial => "listing_conversations/transaction_agreement_checkbox"

      - if quantity
        = hidden_field_tag :quantity, quantity

      - if delivery_method
        = hidden_field_tag :delivery, delivery_method

      .row
        .col-12.paypal-button-wrapper
          = button_tag t("paypal.pay_with_paypal"), class: "checkout-with-paypal-button"

      .row
        .col-12
          = render :partial => "listing_conversations/paypal_payment_methods", locals: { country_code: country_code }

      .row
        .col-12
          %p
            = t("listing_conversations.preauthorize.you_will_be_charged", author: author_link, expiration_period: expiration_period).html_safe


  %noscript
    = "For security reasons JavaScript has to be enabled"






%script{:src => "https://www.gstatic.com/firebasejs/3.6.1/firebase.js"}
:javascript

  // Initialize Firebase
  var current_user = "#{@current_user.id}"
  var current_community= "#{@current_community.id}";

  //var a = document.getElementById("message_conversation_id").value;
  var config = {
    apiKey: "AIzaSyAmzQbCOTI58tmUqsuia3uUfUClvRzu6zM",
    authDomain: "vendoradvisor-4df3f.firebaseapp.com",
    databaseURL: "https://vendoradvisor-4df3f.firebaseio.com",
    storageBucket: "vendoradvisor-4df3f.appspot.com",
    messagingSenderId: "795403313668"
  };
  firebase.initializeApp(config);
  var dbrefSB = firebase.database().ref().child('transaction_beep');
  dbrefSB.on('value' , function(snap){
    // var c = 0;
    console.log("this is firebase snap",snap)
    obj = snap.val();
    $.each(obj , function( key , element ){
      var p_id= element.person_id;
      if(element.person_id == current_user && element.community_id == current_community && element.transaction_id){
        console.log("window location");
        console.log(window.location);
        console.log("window origin");
        console.log(window.location.origin);
        console.log("transaction id");
        console.log(element.transaction_id);
        window.location=window.location.origin+"/en/transactions/"+element.transaction_id;
      }
      else{
        console.log("transaction id");
        console.log(element.transaction_id);
        console.log("transaction id is null");
        location.reload();
      }
      // get_messages_update(element.current_username);
      dbrefSB.child( key ).remove();
    });

  });

  // function update_unreadC(){
  // $.get( "<%= person_messages_get_message_count_path %>",function(data, status){ if(status == 'success'){console.log(data); if(data // > 0){
  // $(".unreadC").html(data);} } }); }
